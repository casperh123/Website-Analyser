@page "/Website/{WebsiteId:guid}/order-check"

@using WebsiteAnalyzer.Core.Domain
@using WebsiteAnalyzer.Core.Domain.OrderChecks
@using WebsiteAnalyzer.Core.Enums
@using WebsiteAnalyzer.Core.Interfaces.Services
@using WebsiteAnalyzer.Web.Components.Layout

@inherits WebsiteAnalyzer.Web.Components.Templates.WebsiteComponent

@inject IScheduleService ScheduleService
@inject IOrderCheckService OrderCheckService

<WebsiteStatsLayout Website="Website" Websites="Websites">
    <RadzenCard>
        <RadzenStack>
        <RadzenText TextStyle="TextStyle.DisplayH4">Ordercheck</RadzenText>
        <RadzenCard>
            <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                @if (ScheduledAction is null)
                {
                    <RadzenButton Click="AddCheck">Add check</RadzenButton>
                }
                else
                {
                    <RadzenStack>
                        <RadzenButton Click="DeleteCheck" ButtonStyle="ButtonStyle.Danger"> Remove Check</RadzenButton>
                    
                        <RadzenStack>
                            <RadzenStack>
                                <RadzenText>API Key</RadzenText>
                                <RadzenTextBox Value="@Keys?.Key" ValueChanged="UpdateKey"/>
                            </RadzenStack>
                            <RadzenStack>
                                <RadzenText>API Secret</RadzenText>
                                <RadzenTextBox Value="@Keys?.Secret" ValueChanged="UpdateSecret"/>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenStack>
                }
                
                <RadzenStack>
                    <RadzenText TextStyle="TextStyle.DisplayH3">Last Check</RadzenText>
                    <RadzenText>Time since last order: @LatestCheck?.TimeSinceLastOrder.ToString(@"hh\:mm")</RadzenText>
                    <RadzenButton Click="CheckNow">Check now</RadzenButton>
                </RadzenStack>
            </RadzenRow>
        </RadzenCard>

        </RadzenStack>
    </RadzenCard>
</WebsiteStatsLayout>

@code {
    public ScheduledAction? ScheduledAction { get; set; }
    private OrderCheckKeys? Keys { get; set; }
    private OrderCheck? LatestCheck { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (Website is null)
        {
            return;
        }
        
        ScheduledAction = await ScheduleService.GetActionByWebsiteIdAndType(Website.Id, CrawlAction.OrderCheck);
        Keys = await OrderCheckService.GetKeysByWebsiteId(WebsiteId) ?? new OrderCheckKeys(WebsiteId, "", "");
        LatestCheck = await OrderCheckService.GetLatestByWebsiteId(WebsiteId);
    }

    public async Task AddCheck()
    {
        ScheduledAction = await ScheduleService.ScheduleAction(Website, CrawlAction.OrderCheck, Frequency.ThreeHourly);
    }

    public async Task DeleteCheck()
    {
        await ScheduleService.DeleteAction(ScheduledAction);
        ScheduledAction = null;
    }

    public async Task UpdateKey(string? key)
    {
        Keys.Key = key;
        await OrderCheckService.UpdateKeys(Keys);
    }

    public async Task UpdateSecret(string? secret)
    {
        Keys.Secret = secret;
        await OrderCheckService.UpdateKeys(Keys);
    }

    public async Task CheckNow()
    {
        LatestCheck = await OrderCheckService.CheckOrder(WebsiteId);
    }
}