@page "/Website/{WebsiteId:guid}/brokenlinks"

@using Crawler.Models
@using WebsiteAnalyzer.Core.Contracts
@using WebsiteAnalyzer.Core.Contracts.BrokenLink
@using WebsiteAnalyzer.Core.Domain
@using WebsiteAnalyzer.Core.Enums
@using WebsiteAnalyzer.Core.Interfaces.Services
@using WebsiteAnalyzer.Web.Components.BrokenLink.Cards
@using WebsiteAnalyzer.Web.Components.Layout
@using WebsiteAnalyzer.Web.Components.ScheduledAction
@using WebsiteAnalyzer.Web.Components.WebsiteInputs

@inherits WebsiteAnalyzer.Web.Components.Templates.WebsiteComponent

@inject IBrokenLinkService BrokenLinkService
@inject IScheduleService ScheduledActionService

<WebsiteStatsLayout Website="Website" Websites="Websites">
    
    <RadzenCard>
        <RadzenStack>
            <RadzenText TextStyle="TextStyle.DisplayH4">Broken Link Crawls</RadzenText>
            <RadzenCard>
                <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <ScheduledActionStatus ScheduledAction="ScheduledAction"/>

                    @if (ScheduledAction.Status != Status.InProgress)
                    {
                        <WebsiteInput 
                            IsProcessing="IsProcessing"
                            LinksChecked="_linksChecked"
                            LinksEnqueued="_linksEnqueued"
                            OnCancel="CancelProcessing"
                            Variant="Variant.Text"
                            ShowUrl="false"
                            Url="@Website?.Url"
                            WebsiteActionStarted="FindBrokenLinks"
                            ButtonText="Find broken links"/>
                    }
                </RadzenRow>
            </RadzenCard>

            @if (BrokenLinkCrawls.Any())
            {
                <RadzenStack Gap="20px" Style="margin-top: 20px;">
                    @foreach (BrokenLinkCrawlDTO brokenLink in BrokenLinkCrawls)
                    {
                        <BrokenLinkCrawlCard Crawl="brokenLink"></BrokenLinkCrawlCard>
                    }
                </RadzenStack>
            }
            else
            {
                <RadzenText>There are no broken link crawls yet.</RadzenText>
            }
        </RadzenStack>
    </RadzenCard>
</WebsiteStatsLayout>

@code {
    public ICollection<BrokenLinkCrawlDTO>? BrokenLinkCrawls { get; set; }
    
    public ScheduledAction? ScheduledAction { get; set; }
    
    private int _linksEnqueued;
    private int _linksChecked;
    private IProgress<CrawlProgress> _progress;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (Website is null)
        {
            return;
        }

        _progress = new Progress<CrawlProgress>(p =>
        {
            _linksChecked = p.TotalCrawled;
            _linksEnqueued = p.QueueSize;
            InvokeAsync(StateHasChanged);
        });

        ScheduledAction = await ScheduledActionService.GetActionByWebsiteIdAndType(Website.Id, CrawlAction.BrokenLink);
        BrokenLinkCrawls = await BrokenLinkService.GetBrokenLinkCrawlsByUrlAndUserId(Website.Url, User.Id);
    }

    public async Task FindBrokenLinks()
    {
        await StartProcessingAsync(async token =>
        {
            _linksChecked = 0;
            _linksEnqueued = 0;
            
            await BrokenLinkService.FindBrokenLinks(Website, _progress, token);
        });
        
        BrokenLinkCrawls = await BrokenLinkService.GetBrokenLinkCrawlsByUrlAndUserId(Website.Url, User.Id);
    }
}